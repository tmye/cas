{% extends 'base.html.twig' %}

{% block title %}
    {{ parent()~"Machine" }}
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="wrapper">

        {% include('cas/partials/_sidebar.html.twig') %}

        <div class="content-page">
            <div class="content">
                <div class="col-lg-12"><h2 class="page-title"><span class="uil-laptop"></span> Machines enregistrées</h2></div>
                <div class="row card">
                    <div class="col l12 card-body">
                        <h5 class="page-title"><span class="uil-laptop"></span> Machines enregistrées</h5>
                        <p class="description_message">Enrégistrez une nouvelle machine ou modifier une existante et attribuez la à des départements auparavent créés</p>
                        <div class="row">
                            <div class="col l12">
                                <ul class="collapsible" data-collapsible="accordion">
                                    <li>
                                        <div class="collapsible-header active">Ajouter une nouvelle machine à la base de données</div>
                                        <div class="collapsible-body" style="padding-bottom: 0px">
                                            {% for message in  app.session.flashbag.get('notice') %}
                                                <div class="row">
                                                    <div class="col l12">
                                                        <div class="operation_message">
                                                            {{ message }}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <div class="row">
                                                <div class="col l12">
                                                    {{ form_start(form) }}
                                                    <div class="row">
                                                        <div class="input-field col s6">
                                                            <spn>Nom de la machine</spn>
                                                            {{ form_row(form.name, {'attr': {'class': 'form-control input-customized','placeholder':'Nom de la machine'}}) }}
                                                        </div>
                                                        <div class="input-field col s6">
                                                            <spn>Identifiant de la machine</spn>
                                                            {{ form_row(form.machineId, {'attr': {'class': 'mb-2 form-control input-customized','placeholder':'Identifiant de la machine'}}) }}
                                                        </div>
                                                    </div>
                                                    <div class="row" style="">
                                                        <div class="input-field col s12">
                                                            <span>Description</span>
                                                            {{ form_row(form.description, {'attr': {'class': 'form-control materialize-textarea','placeholder':''}}) }}
                                                            <br>
                                                        </div>
                                                    </div>
                                                    <p style="margin-top: -50px">
                                                        <input type="checkbox" class="checkIt" id="filled-in-box" />
                                                        <label for="filled-in-box">Tous les départements</label>
                                                    </p>
                                                    <br><br>
                                                    <div class="row" >
                                                        <div class="input-field col s12">
                                                            {{ form_row(form.departements, {'attr': { 'class': 'form-control selectpicker','multiple':'', 'data-live-search':'true' }}) }}
                                                        </div>
                                                    </div>
                                                    <div class="row mt-3">
                                                        <div class="input-field col s12">
                                                            {{ form_widget(form.Ajouter, { 'label': 'Ajouter','attr': {'class':'btn btn-lg btn-success'} }) }}
                                                        </div>
                                                    </div>
                                                    <div class="row" style="position: relative;top: -40px">
                                                        <div class="input-field col s12">
                                                            {{ form_rest(form) }}
                                                        </div>
                                                    </div>
                                                    {{ form_end(form) }}
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col l12">
                                <ul class="collapsible" data-collapsible="accordion">
                                    <li>
                                        <div class="collapsible-header active">Liste des machines présentes en base de données</div>
                                        <div class="collapsible-body" style="padding-bottom: 0px">
                                            <div class="row">
                                                <div class="col l12">
                                                    <table class="table table-striped bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Nom</th>
                                                                <th>Machine Id</th>
                                                                <th>Description</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        {% for machine in machines %}
                                                            <tr>
                                                                <td>{{ machine.id }}</td>
                                                                <td>{{ machine.name }}</td>
                                                                <td>{{ machine.machineId }}</td>
                                                                <td>{{ machine.description }}</td>
                                                                <td>
                                                                    <a href="editMachine/{{ machine.id }}">
                                                                        <button class="simple-button-decoration btn btn-outline-primary blue"><span class="uil-pen white-text"></span></button>
                                                                    </a>
                                                                    <button class="simple-button-decoration btn btn-danger red deleteMachine" identify="{{ machine.id }}"><span class="uil-trash white-text"></span></button>
                                                                    {% set deps ="" %}
            
                                                                    {% for mac in machine.departements %}
                                                                        {% set deps = deps~mac.name %}
            
                                                                        {% if not loop.last %}
                                                                            {% set deps = deps~"," %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    <button data-target="modal-formulaire{{ machine.id }}" class="simple-button-decoration btn btn-primary green lighten-2 machineDep modal-trigger" deps="{{ deps }}" identify="{{ machine.id }}"><span class="uil-eye white-text"></span></button>
                                                                </td>
                                                            </tr>
                                                            <div id="modal-formulaire{{ machine.id }}" class="modal modal-fixed-footer">
                                                                <div class="modal-content">
                                                                    <h5>Liste des départements</h5>
                                                                    <hr>
                                                                    <p>Liste des départements en relation avec cette machine</p>
                                                                    <div class="row">
                                                                        <div class="col s12">
                                                                            <ol>
                                                                                {% for m in machine.departements %}
                                                                                    <li>{{ m.name }}</li>
                                                                                {% endfor %}
                                                                            </ol>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    <script>
        $(function () {
            $('#form_Ajouter').click(function () {
                if($('.select_dropdown').val() == undefined){
                    //alert("Aucun département n'a été sélectionné");
                }
            });
        });
    </script>
    <script>
        $(function(){
            $(".deleteMachine").click(function(){
                var rep = confirm("Etes-vous sur de vouloir supprimer cette machine?");
                var id = this.getAttribute('identify');
                var path = "deleteMachine/";
                path += id;
                if(rep==true){
                    //alert("inside true block");
                    window.location.href = path;
                }
            });

            /*$(".machineDep").click(function(){
                var deps = this.getAttribute('deps');
                alert("Liste des départements\n\n\t"+deps);
            });*/
        });
    </script>
    <script>
        $(function(){
            $(".checkIt").change(function() {
                if(this.checked) {
                    $('.select-wrapper').hide();
                    $(".multiple-select-dropdown li span input:checkbox:not(:checked)").click();
                }else{
                    $('.select-wrapper').show();
                    $(".multiple-select-dropdown li span").click();
                }
            });
        });
    </script>
    <script>
        // On s'attaque aux collapsibles
        $(function () {
            $(".cl_Mac").addClass("collapsible_element_active");
            $(".navigation_collapsible").collapsible('open',6);
        });
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script>
        $(function () {
            $('select').selectpicker();
        });
    </script>

{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
{% endblock %}
