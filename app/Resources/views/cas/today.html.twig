{% extends 'base.html.twig' %}


{% block title %}C.A.S - Historique{% endblock %}

{% block stylesheets %}
{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="wrapper">

        {% include('cas/partials/_sidebar.html.twig') %}

        <div class="content-page">
            <div class="content">

                <!-- Modal for ajax loading -->
                <div id="modal_loading" class="modal ajax_modals">
                    <div class="modal-content">
                        <p class="center">
                            <img src="{{ asset('img/ajax_loaders/ajax-loading.gif') }}">
                        </p>
                    </div>
                </div>

                <!-- Modal for details -->
                <div id="modal_detail" class="modal">
                    <div class="modal-content">
                        <h5>Historique de cet employé</h5>
                        <hr>
                        <br>
                        <div class="row">
                            <div class="col s12">
                                <table class="table table-striped table-condensed">
                                    <tbody>
                                    <tr id="modal_element"></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <h2 class="page-title">
                        <span class="uil-clock"></span>
                        Activités de ce jour
                    </h2>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form method="POST" action="{{ path('generateTodayPDF') }}" target="_blank" id="form_pdf" style="display:none">
                        </form>

                        <form method="POST" enctype="multipart/form-data" action="{{ path('generateTodayExcel') }}" target="_blank" id="form_excel" style="display:none">
                        </form>

                        <div class="row">
                            <div class="col-lg-12">

                                <span class="right" style="margin-top:-35px">
                                    <button class="btn-perso-historique btn btn-lg btn-primary export_pdf_btn" style="display: none;" id="submitPDF"><span class="fa fa-file-pdf"></span> Exporter vers PDF</button>
                                    <button class="btn-perso-historique btn btn-lg btn-success export_excel_btn" id="submitExcel"><span class="fa fa-file-excel"></span> Exporter vers Excel</button>
                                </span>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <br><br>
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <span style="position: relative;top: 20px;" class="description_message">Filtrez les resultats en choisissant un département</span>
                                            </div>
                                            <div class="col-lg-6 mb-3">
                                                <select class="form-control" id="depSelect">
                                                    <option value="">Département</option>
                                                    {% for dep in listDep %}
                                                        <option value="{{ dep.name }}">{{ dep.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-lg-6 mb-3">
                                                <select class="form-control" id="sortInput">
                                                    <option value="Arrivée">Arrivée</option>
                                                    <option value="Pause">Pause</option>
                                                    <option value="Retour Pause">Retour Pause</option>
                                                    <option value="Départ">Départ</option>
                                                </select>
                                            </div>
                                        </div>
                                        <table class="table table-bordered table-striped table-centered mt-5" id="presenceTable">
                                            <thead>
                                                <tr>
                                                    <th>Heure</th>
                                                    <th>Employé</th>
                                                    <th>Fonction</th>
                                                    <th>Type</th>
                                                </tr>
                                            </thead>

                                            <tbody id="rowsContainer">
                                            {% for cr in listCR %}
                                                <tr>
                                                    <td>
                                                        {{ cr[0].ClockinTime | date('H:i') }}
                                                    </td>
                                                    <td>
                                                        {{ cr[0].employe.surname~" "~cr[0].employe.lastName }}
                                                    </td>
                                                    <td>
                                                        {{ cr[0].employe.function }}
                                                    </td>
                                                    <td>
                                                        {{ cr[1] }}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script>
        $(function () {

            // We load datas
            var savedData = null;
            var link = '{{ path("returnTodayClockinRecords") }}';
            $.ajax({
                type: 'GET',
                url: link,
                success: function(data) {
                    console.log(data);
                    savedData = data;
                }
            });

            $("#depSelect").change(function(){
                /* On vide le contenu de la table */
                $("#rowsContainer").html("");
                /* On récupère le département sélectionné */
                var selectedDep = $("#depSelect").val();
                //var table = $("#presenceTable").DataTable();

                for(var i=0;i<savedData.length;i++){
                    if(savedData[i].departement == selectedDep && savedData[i].type){

                        $("#rowsContainer").append("" +
                            "<tr>" +
                                "<td>"+savedData[i].hour+"</td>" +
                                "<td>"+savedData[i].employe+"</td>" +
                                "<td>"+savedData[i].function+"</td>" +
                                "<td tag="+savedData[i].type+" >"+savedData[i].type+"</td>" +
                            "</tr>"
                        );
                    }
                }
            });
        });
    </script>
    <script>
        $(function(){
            $("#submitPDF").click(function(){
                $("#form_pdf").submit();
            });
            $("#submitExcel").click(function(){
                $("#form_excel").submit();
            });
        });
    </script>
    <script>

        function sortTable(table_id, type) {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById(table_id);
            switching = true;
            /* Make a loop that will continue until
            no switching has been done: */
/*
            while (switching) {
                // Start by saying: no switching is done:
                switching = false;
                rows = table.rows;
                /!* Loop through all table rows (except the
                first, which contains table headers): *!/
                for (i = 1; i < rows.length; i++) {
                    // Start by saying there should be no switching:
                    shouldSwitch = false;
                    /!* Get the two elements you want to compare,
                    one from current row and one from the next: *!/
                    x = rows[i].getElementsByTagName("TD")[3];
                    //y = rows[i + 1].getElementsByTagName("TD")[3];
                    // Check if the two rows should switch place:
                    if (x.innerHTML != type) {

                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    /!* If a switch has been marked, make the switch
                    and mark that a switch has been done: *!/
                    console.log(rows[i]);
                    switching = true;
                }
            }
*/
        }
        // On s'attaque aux collapsibles
/*        $(function () {
            $("#sortInput").on('change', function (e){
                sortTable('presenceTable', $(this).val())
                $('#presenceTable').DataTable();
            })

        });*/

        $(document).ready( function () {
            $('#presenceTable').DataTable();
        } );
    </script>
{% endblock %}