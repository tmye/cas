{% extends 'base.html.twig' %}
{% block body %}
    <div class="row">
        <div class="col l9 offset-l3">
            <h5>Informations sur un employé</h5>
            <div class="row">
                <div class="col l12">
                    <ul class="collapsible popout" data-collapsible="">
                        <li>
                            <div class="collapsible-header active">
                                Choix du département
                            </div>
                            <div class="collapsible-body" style="padding-bottom: 0px">
                                <div class="row">
                                    <div class="col l6">
                                        <span>Veuillez choisir le département <span class="red-text">*</span></span>
                                    </div>
                                    <div class="col l6">
                                        <select class="input-customized browser-default" id="depSelect">
                                            <option value="" selected>Département</option>
                                            {% for dep in listDep %}
                                                <option value="{{ dep.id }}">{{ dep.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col l12">
                                        <table class="bordered striped">
                                            <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Profil</th>
                                                <th>Nom et prénoms</th>
                                                <th>Fonction</th>
                                                <th>Salaire</th>
                                                <th>Téléphone</th>
                                                <th>Adresse</th>
                                                <th>Date d'emploi</th>
                                                <th>Edit</th>
                                            </tr>
                                            </thead>
                                            <tbody id="rowsContainer">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {# Script Ajax de chargement des données #}
    <script>
        $(function(){
            alert("appel de la fonction");

            /* Création de la fonction de chargement des données */

            function loadData () {
                var idEl = $("#depSelect").val();
                var link = '{{ path("returnEmployees") }}';
                alert(link);
                $.ajax({
                    type: 'GET',
                    url: link,
                    success: function(data) {
                        var res = JSON.parse(data);
                        alert("Le résultat : "+data);
                        alert("la longueur : "+res.employees.length);
                        /* Au changement d'un département,plus de requete.On ne fait que charger les données */
                        $("#depSelect").change(function(){
                            /* On vide le contenu de la table */
                            $("#rowsContainer").html("");
                            /* On récupère le département sélectionné */
                            var selectedDep = $("#depSelect").val();
                            for(var i=0;i<res.employees.length;i++){
                                //alert("L'id dep est "+res.employees[i].departement.id);
                                /* On vérifie si oui ou nom cet employé appartient au département
                                 * Si oui on l'affiche
                                 * Sinon on l'ignore tout simplement
                                 */
                                if(res.employees[i].departement.id == selectedDep){
                                    var mDate = new Date(res.employees[i].hireDate.timestamp*1000).toLocaleDateString();
                                    alert(mDate);
                                    $("#rowsContainer").append("" +
                                        "<tr>" +
                                        "<td>"+res.employees[i].id+"</td>" +
                                        "<td><img src=\"{{ asset('uploads/img/') }}"+res.employees[i].picPath+"\" alt=\" profil_picture\" style=\"width:50px;height:50px\"></td>" +
                                        "<td>"+res.employees[i].surname+" "+res.employees[i].lastName+"</td>" +
                                        "<td>"+res.employees[i].function+"</td>" +
                                        "<td>"+res.employees[i].salary+"</td>" +
                                        "<td>"+res.employees[i].contact+"</td>" +
                                        "<td>"+res.employees[i].adress+"</td>" +
                                        "<td>"+mDate+"</td>" +
                                        "<td><a href=\"editEmployee/"+res.employees[i].id+"\"><button class=\"white-text blue simple-button-decoration\"><span class=\"fa fa-pencil-alt\"></span></button></a> <button class=\"white-text red simple-button-decoration\" onclick=\"demander("+res.employees[i].id+")\"><span class=\"fa fa-trash\"></span></button></td>" +
                                        "</tr>"
                                    );
                                }
                            }
                        });
                    },
                    error: function(msg) {
                        alert("erreur"); }
                });
            }
            loadData();
        });
    </script>
    <script>
        function demander(theId) {
            var rep = confirm("Etes-vous sur de vouloir supprimer cet employé?");
            var path = "/cas/web/app_dev.php/deleteEmployee/";
            path += theId;
            if(rep==true){
                window.location.href = path;
            }
        }
    </script>
{% endblock %}

{% block stylesheets %}
{% endblock %}
